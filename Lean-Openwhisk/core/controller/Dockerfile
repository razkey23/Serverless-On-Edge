# Licensed to the Apache Software Foundation (ASF) under one or more contributor
# license agreements; and to You under the Apache License, Version 2.0.

FROM arm32v7/openjdk:8u181-jdk

ENV UID=1001 \
    NOT_ROOT_USER=owuser
ENV SWAGGER_UI_DOWNLOAD_SHA256=3d7ef5ddc59e10f132fe99771498f0f1ba7a2cbfb9585f9863d4191a574c96e7 \
    SWAGGER_UI_VERSION=3.6.0

ENV JRE_HOME ${JAVA_HOME}/jre

###################################################################################################
# It's needed for lean mode where the controller is also an invoker
###################################################################################################
#ENV DOCKER_VERSION=1.12.0 \
#    DOCKER_DOWNLOAD_SHA256=3dd07f65ea4a7b4c8829f311ab0213bca9ac551b5b24706f3e79a97e22097f8b

#RUN apk add --update openssl

# Uncomment to fetch latest version of docker instead: RUN wget -qO- https://get.docker.com | sh
# Install docker client
RUN curl -sSL https://download.docker.com/linux/static/stable/armel/docker-17.12.1-ce.tgz>docker-17.12.1-ce.tgz && \
tar --strip-components 1 -xvzf docker-17.12.1-ce.tgz -C /usr/bin docker/docker && tar --strip-components 1 -xvzf docker-17.12.1-ce.tgz  -C /usr/bin docker/docker-runc && chmod +x /usr/bin/docker && chmod +x /usr/bin/docker-runc && rm -f docker-17.12.1-ce.tgz

#RUN curl -sSL -o docker-${DOCKER_VERSION}.tgz https://get.docker.com/builds/Linux/x86_64/docker-${DOCKER_VERSION}.tgz && \
#echo "${DOCKER_DOWNLOAD_SHA256}  docker-${DOCKER_VERSION}.tgz" | sha256sum -c - && \
#tar --strip-components 1 -xvzf docker-${DOCKER_VERSION}.tgz -C /usr/bin docker/docker && \
#tar --strip-components 1 -xvzf docker-${DOCKER_VERSION}.tgz -C /usr/bin docker/docker-runc && \
#rm -f docker-${DOCKER_VERSION}.tgz && \
#chmod +x /usr/bin/docker && \
#chmod +x /usr/bin/docker-runc
##################################################################################################

# Install swagger-ui
RUN curl -sSL -o swagger-ui-v${SWAGGER_UI_VERSION}.tar.gz --no-verbose https://github.com/swagger-api/swagger-ui/archive/v${SWAGGER_UI_VERSION}.tar.gz && \
    echo "${SWAGGER_UI_DOWNLOAD_SHA256}  swagger-ui-v${SWAGGER_UI_VERSION}.tar.gz" | sha256sum -c - && \
    mkdir swagger-ui && \
    tar zxf swagger-ui-v${SWAGGER_UI_VERSION}.tar.gz -C /swagger-ui --strip-components=2 swagger-ui-${SWAGGER_UI_VERSION}/dist && \
    rm swagger-ui-v${SWAGGER_UI_VERSION}.tar.gz && \
    sed -i s#http://petstore.swagger.io/v2/swagger.json#/api/v1/api-docs#g /swagger-ui/index.html

# Copy app jars
ADD build/distributions/controller.tar /

COPY init.sh /

COPY transformEnvironment.sh /
RUN chmod +x transformEnvironment.sh

COPY copyJMXFiles.sh /
RUN chmod +x copyJMXFiles.sh


RUN chmod +x init.sh

RUN adduser --uid ${UID} --disabled-password --gecos "" --home /home/${NOT_ROOT_USER} --shell /bin/bash ${NOT_ROOT_USER}

# It is possible to run as non root if you dont need invoker capabilities out of the controller today
#USER ${NOT_ROOT_USER}

RUN mkdir /logs

EXPOSE 8080
CMD ["./init.sh", "0"]
